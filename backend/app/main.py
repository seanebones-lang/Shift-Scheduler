from typing import List, Dict\nfrom pydantic import BaseModel\nfrom fastapi import FastAPI, UploadFile, File, HTTPException, Body\nfrom fastapi.middleware.cors import CORSMiddleware\nimport pandas as pd\nimport io\nfrom datetime import datetime, timedelta\nfrom prophet import Prophet\n\napp = FastAPI(title=\"ShiftAI Scheduler API\")\n\napp.add_middleware(\n    CORSMiddleware,\n    allow_origins=[\"*\"],\n    allow_credentials=True,\n    allow_methods=[\"*\"],\n    allow_headers=[\"*\"],\n)\n\nclass ForecastInterval(BaseModel):\n    time: str\n    demand: float\n    confidence_low: float\n    confidence_high: float\n\nclass Forecast(BaseModel):\n    intervals: List[ForecastInterval]\n\nclass Shift(BaseModel):\n    staff_id: str\n    name: str\n    start: str\n    end: str\n    cost: float\n\nclass Schedule(BaseModel):\n    shifts: List[Shift]\n    total_cost: float\n\n@app.get(\"/health\")\ndef health():\n    return {\"status\": \"healthy\", \"timestamp\": datetime.now().isoformat()}\n\n@app.post(\"/forecast\", response_model=Forecast)\nasync def forecast_sales(file: UploadFile = File(...)):\n    if not file.filename.endswith('.csv'):\n        raise HTTPException(status_code=400, detail=\"CSV file required\")\n    content = await file.read()\n    try:\n        df = pd.read_csv(io.BytesIO(content))\n        if 'sales' in df.columns and len(df) > 0:\n            # Mock legacy\n            base_demand = df['sales'].mean()\n            intervals = []\n            for i in range(168):  # 7 days hourly\n                dt = datetime.now() + timedelta(hours=i)\n                demand = base_demand * (1.5 if 8 <= dt.hour < 18 else 0.7)\n                low, high = demand * 0.8, demand * 1.2\n                intervals.append(ForecastInterval(\n                    time=dt.isoformat(),\n                    demand=round(demand, 2),\n                    confidence_low=round(low, 2),\n                    confidence_high=round(high, 2)\n                ))\n            return Forecast(intervals=intervals)\n        elif 'ds' in df.columns and 'y' in df.columns:\n            # Real Prophet\n            df['ds'] = pd.to_datetime(df['ds'])\n            m = Prophet(interval_width=0.8, daily_seasonality=True, weekly_seasonality=True)\n            m.fit(df)\n            future = m.make_future_dataframe(periods=168, freq='H')\n            forecast_df = m.predict(future)\n            intervals = []\n            for _, row in forecast_df.tail(168).iterrows():\n                dt = row['ds']\n                demand = float(row['yhat'])\n                low = float(row['yhat_lower'])\n                high = float(row['yhat_upper'])\n                intervals.append(ForecastInterval(\n                    time=dt.isoformat(),\n                    demand=round(demand, 2),\n                    confidence_low=round(low, 2),\n                    confidence_high=round(high, 2)\n                ))\n            return Forecast(intervals=intervals)\n        else:\n            raise HTTPException(status_code=400, detail=\"CSV must have 'sales' or ('ds', 'y') columns\")\n    except Exception as e:\n        raise HTTPException(status_code=500, detail=str(e))\n\n@app.post(\"/optimize\", response_model=Schedule)\nasync def optimize_shifts(forecast_file: UploadFile = File(...), staff_file: UploadFile = File(...)):\n    # Mock for now, OR-Tools later\n    f_content = await forecast_file.read()\n    s_content = await staff_file.read()\n    try:\n        staff_df = pd.read_csv(io.BytesIO(s_content))\n        if not {'id', 'name', 'wage', 'skill'} <= set(staff_df.columns):\n            raise HTTPException(status_code=400, detail=\"Staff CSV columns: id,name,wage,skill\")\n        shifts = []\n        total_cost = 0\n        for _, row in staff_df.iterrows():\n            start = datetime.now().isoformat()\n            end = (datetime.now() + timedelta(hours=8)).isoformat()\n            cost = row['wage'] * 8\n            shifts.append(Shift(\n                staff_id=str(row['id']),\n                name=row['name'],\n                start=start,\n                end=end,\n                cost=float(cost)\n            ))\n            total_cost += float(cost)\n        return Schedule(shifts=shifts, total_cost=round(total_cost, 2))\n    except Exception as e:\n        raise HTTPException(status_code=500, detail=str(e))\n\nif __name__ == \"__main__\":\n    import uvicorn\n    uvicorn.run(\"app.main:app\", host=\"0.0.0.0\", port=8000, reload=True)\n